# Amplify / AWS setup for VisitJo preferences & uploads

This folder contains helper Lambda code and deployment instructions to add S3 upload (presigned PUT) and a user profile API (DynamoDB) to your Amplify project.

Files in this folder:
- `presign-upload/index.js` - Lambda to return S3 presigned PUT URL + key
- `user-profile/index.js` - Lambda to read/write a user's profile stored in DynamoDB (`userId` is Cognito `sub`)
- `package.json` - dependencies for the Lambdas
- `s3-cors.json` - example S3 CORS policy JSON you can apply to the bucket
- `iam-policy-s3-dynamodb.json` - example IAM policy for the Lambda role (replace placeholders)

Overview of steps (recommended):

1) Install/Configure Amplify CLI and AWS credentials
   - `npm install -g @aws-amplify/cli`
   - `amplify configure` (follow browser flow)

2) Add S3 storage for user images
   - `amplify add storage`
     - Select: Content (Images, audio, video, etc.)
     - Provide a friendly name (e.g. `userimages`)
     - Provide bucket name (or accept autogenerated)
     - Restrict access: Auth users only
     - Allow read/write for authenticated users
   - After creation, note the bucket name (or use `amplify status`)
   - Apply CORS (optional via AWS Console or `aws s3api put-bucket-cors --bucket <bucket> --cors-configuration file://amplify-helpers/s3-cors.json`)

3) Add DynamoDB table for user profiles
   - `amplify add storage`
     - Select: NoSQL Database
     - Provide table name (e.g. `UserProfiles`)
     - Primary key: `userId` (String)
     - Configure read/write capacity (on-demand recommended)

4) Add two Lambda functions
   - `amplify add function` -> `presignUpload` (NodeJS)
     - After creation, copy the code from `amplify-helpers/presign-upload/index.js` into `amplify/backend/function/presignUpload/src/index.js` (or the path Amplify created)
     - Set environment variables for the function: `BUCKET_NAME` (your bucket)
     - Grant the function access to S3: choose to update IAM policies during amplify add or via `amplify update function`
   - `amplify add function` -> `userProfile` (NodeJS)
     - Copy `amplify-helpers/user-profile/index.js` into the function's `src/index.js`
     - Set environment variables: `TABLE_NAME` (your DynamoDB table name)
     - Grant the function access to DynamoDB (and optionally S3 if you'd like to expose signed GETs)

5) Add REST API endpoints
   - `amplify add api`
     - Select: REST
     - Provide name (e.g. `visitjo-api`)
     - Path: `/uploads/signed-url` -> Lambda: `presignUpload`
     - Path: `/user/profile` -> Lambda: `userProfile`
     - Enable CORS for your frontend origin(s)
     - Configure authentication: use AWS_IAM or Cognito User Pool authorizer (Cognito recommended). If using Cognito, the Lambda authorizer will receive `event.requestContext.authorizer.claims` including the user's `sub`.

6) Configure environment variables and IAM bindings
   - For each function make sure `BUCKET_NAME` and `TABLE_NAME` are set (Amplify UI for function env vars or `amplify function update`)
   - Attach the `iam-policy-s3-dynamodb.json` permissions to the Lambda role (Amplify will usually attach via `amplify update function` when you allow access to storage resources)

7) Deploy
   - `amplify push` (this will create S3, DynamoDB, Lambdas, API Gateway, and connect them)

8) Frontend wiring
   - After deploy, update your runtime config or `.env` so `VITE_API_GATEWAY_URL` points to the API Gateway base URL (Amplify prints this after push).
   - The frontend already uses `/uploads/signed-url` and `/user/profile` paths in `hotelAPI` and `Profile.jsx`.
   - Ensure your frontend calls include Authorization header (Cognito JWT). Amplify Auth or your auth layer should set `Authorization: Bearer <token>` on `apiClient`.

Notes and best practices
- Keep S3 objects private and only use presigned PUT/GET to move files.
- Store only the S3 key in DynamoDB (e.g. `avatarKey`) and construct a signed GET URL when serving protected images.
- If you want public avatars, consider creating a CloudFront distribution or enabling public-read only on specific keys (not recommended).
- Test locally in mock mode by setting `visitjo.useMocks=1` in localStorage; then the frontend will avoid calling API.

If you want, I can now:
- Create Amplify backend resource templates in `amplify/backend/*` for you to `amplify push` (I can scaffold the function directories and basic cloudformation templates), or
- Run these Amplify CLI commands for you (I cannot access your AWS credentials from here â€” you'll need to run them), or
- Deploy a CloudFormation / SAM template instead (if you prefer not to use Amplify).

Which deployment method should I scaffold for you now? (Amplify function scaffolding, or SAM/CloudFormation templates?)
