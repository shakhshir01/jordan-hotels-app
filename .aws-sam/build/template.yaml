AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: "VisitJo SAM template \u2014 API, Lambdas, DynamoDB, S3, Secrets Manager"
Globals:
  Function:
    Runtime: nodejs18.x
    Timeout: 10
    MemorySize: 512
    Environment:
      Variables:
        AWS_NODEJS_CONNECTION_REUSE_ENABLED: '1'
Resources:
  Api:
    Type: AWS::Serverless::Api
    Properties:
      Name: VisitJoApi
      StageName: prod
      Cors:
        AllowOrigin: '''*'''
        AllowMethods: '''GET,POST,OPTIONS,PUT,DELETE'''
      EndpointConfiguration: REGIONAL
  HotelsTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName:
        Fn::Sub: ${AWS::StackName}-Hotels
      AttributeDefinitions:
      - AttributeName: id
        AttributeType: S
      KeySchema:
      - AttributeName: id
        KeyType: HASH
      BillingMode: PAY_PER_REQUEST
  DestinationsTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName:
        Fn::Sub: ${AWS::StackName}-Destinations
      AttributeDefinitions:
      - AttributeName: id
        AttributeType: S
      KeySchema:
      - AttributeName: id
        KeyType: HASH
      BillingMode: PAY_PER_REQUEST
  DealsTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName:
        Fn::Sub: ${AWS::StackName}-Deals
      AttributeDefinitions:
      - AttributeName: id
        AttributeType: S
      KeySchema:
      - AttributeName: id
        KeyType: HASH
      BillingMode: PAY_PER_REQUEST
  ExperiencesTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName:
        Fn::Sub: ${AWS::StackName}-Experiences
      AttributeDefinitions:
      - AttributeName: id
        AttributeType: S
      KeySchema:
      - AttributeName: id
        KeyType: HASH
      BillingMode: PAY_PER_REQUEST
  BookingsTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName:
        Fn::Sub: ${AWS::StackName}-Bookings
      AttributeDefinitions:
      - AttributeName: id
        AttributeType: S
      KeySchema:
      - AttributeName: id
        KeyType: HASH
      BillingMode: PAY_PER_REQUEST
  UploadsBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName:
        Fn::Sub: ${AWS::StackName}-uploads-${AWS::Region}
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
  StripeSecret:
    Type: AWS::SecretsManager::Secret
    Properties:
      Name:
        Fn::Sub: ${AWS::StackName}/stripe
      Description: Stripe secret for VisitJo (store STRIPE_SECRET here)
  LambdaRolePolicy:
    Type: AWS::IAM::ManagedPolicy
    Properties:
      ManagedPolicyName:
        Fn::Sub: ${AWS::StackName}-managed-policy
      PolicyDocument:
        Version: '2012-10-17'
        Statement:
        - Effect: Allow
          Action:
          - dynamodb:Query
          - dynamodb:Scan
          - dynamodb:GetItem
          - dynamodb:PutItem
          - dynamodb:UpdateItem
          Resource: '*'
        - Effect: Allow
          Action:
          - s3:PutObject
          - s3:GetObject
          - s3:PutObjectAcl
          Resource:
            Fn::Sub: arn:aws:s3:::${UploadsBucket}/*
        - Effect: Allow
          Action:
          - secretsmanager:GetSecretValue
          Resource:
            Fn::Sub: arn:aws:secretsmanager:${AWS::Region}:${AWS::AccountId}:secret:*stripe*
  GetHotelsFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName:
        Fn::Sub: ${AWS::StackName}-getHotels
      Handler: getHotels/index.handler
      Policies:
      - AWSLambdaBasicExecutionRole
      - Ref: LambdaRolePolicy
      Environment:
        Variables:
          HOTELS_TABLE:
            Ref: HotelsTable
      Events:
        ApiGetHotels:
          Type: Api
          Properties:
            Path: /hotels
            Method: GET
            RestApiId:
              Ref: Api
      CodeUri: GetHotelsFunction
    Metadata:
      SamResourceId: GetHotelsFunction
  GetHotelByIdFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName:
        Fn::Sub: ${AWS::StackName}-getHotelById
      Handler: getHotelById/index.handler
      Policies:
      - AWSLambdaBasicExecutionRole
      - Ref: LambdaRolePolicy
      Environment:
        Variables:
          HOTELS_TABLE:
            Ref: HotelsTable
      Events:
        ApiGetHotelById:
          Type: Api
          Properties:
            Path: /hotels/{id}
            Method: GET
            RestApiId:
              Ref: Api
      CodeUri: GetHotelByIdFunction
    Metadata:
      SamResourceId: GetHotelByIdFunction
  SearchFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName:
        Fn::Sub: ${AWS::StackName}-search
      Handler: search/index.handler
      Policies:
      - AWSLambdaBasicExecutionRole
      - Ref: LambdaRolePolicy
      Environment:
        Variables:
          HOTELS_TABLE:
            Ref: HotelsTable
          DESTINATIONS_TABLE:
            Ref: DestinationsTable
          DEALS_TABLE:
            Ref: DealsTable
          EXPERIENCES_TABLE:
            Ref: ExperiencesTable
      Events:
        ApiSearch:
          Type: Api
          Properties:
            Path: /search
            Method: GET
            RestApiId:
              Ref: Api
      CodeUri: SearchFunction
    Metadata:
      SamResourceId: SearchFunction
  DestinationsFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName:
        Fn::Sub: ${AWS::StackName}-destinations
      Handler: destinations/index.handler
      Policies:
      - AWSLambdaBasicExecutionRole
      - Ref: LambdaRolePolicy
      Environment:
        Variables:
          DESTINATIONS_TABLE:
            Ref: DestinationsTable
      Events:
        ApiDestinations:
          Type: Api
          Properties:
            Path: /destinations
            Method: GET
            RestApiId:
              Ref: Api
        ApiDestinationById:
          Type: Api
          Properties:
            Path: /destinations/{id}
            Method: GET
            RestApiId:
              Ref: Api
      CodeUri: DestinationsFunction
    Metadata:
      SamResourceId: DestinationsFunction
  DealsFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName:
        Fn::Sub: ${AWS::StackName}-deals
      Handler: deals/index.handler
      Policies:
      - AWSLambdaBasicExecutionRole
      - Ref: LambdaRolePolicy
      Environment:
        Variables:
          DEALS_TABLE:
            Ref: DealsTable
      Events:
        ApiDeals:
          Type: Api
          Properties:
            Path: /deals
            Method: GET
            RestApiId:
              Ref: Api
        ApiDealById:
          Type: Api
          Properties:
            Path: /deals/{id}
            Method: GET
            RestApiId:
              Ref: Api
      CodeUri: DealsFunction
    Metadata:
      SamResourceId: DealsFunction
  ExperiencesFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName:
        Fn::Sub: ${AWS::StackName}-experiences
      Handler: experiences/index.handler
      Policies:
      - AWSLambdaBasicExecutionRole
      - Ref: LambdaRolePolicy
      Environment:
        Variables:
          EXPERIENCES_TABLE:
            Ref: ExperiencesTable
      Events:
        ApiExperiences:
          Type: Api
          Properties:
            Path: /experiences
            Method: GET
            RestApiId:
              Ref: Api
        ApiExperienceById:
          Type: Api
          Properties:
            Path: /experiences/{id}
            Method: GET
            RestApiId:
              Ref: Api
      CodeUri: ExperiencesFunction
    Metadata:
      SamResourceId: ExperiencesFunction
  BookingsFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName:
        Fn::Sub: ${AWS::StackName}-bookings
      Handler: bookings/index.handler
      Policies:
      - AWSLambdaBasicExecutionRole
      - Ref: LambdaRolePolicy
      Environment:
        Variables:
          BOOKINGS_TABLE:
            Ref: BookingsTable
      Events:
        ApiBookings:
          Type: Api
          Properties:
            Path: /bookings
            Method: ANY
            RestApiId:
              Ref: Api
      CodeUri: BookingsFunction
    Metadata:
      SamResourceId: BookingsFunction
  CreateCheckoutSessionFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName:
        Fn::Sub: ${AWS::StackName}-createCheckoutSession
      Handler: createCheckoutSession/index.handler
      Policies:
      - AWSLambdaBasicExecutionRole
      - Ref: LambdaRolePolicy
      Environment:
        Variables:
          STRIPE_SECRET_ARN:
            Ref: StripeSecret
      Events:
        ApiCheckout:
          Type: Api
          Properties:
            Path: /payments/create-checkout-session
            Method: POST
            RestApiId:
              Ref: Api
      CodeUri: CreateCheckoutSessionFunction
    Metadata:
      SamResourceId: CreateCheckoutSessionFunction
  GetSignedUrlFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName:
        Fn::Sub: ${AWS::StackName}-getSignedUrl
      Handler: getSignedUrl/index.handler
      Policies:
      - AWSLambdaBasicExecutionRole
      - Ref: LambdaRolePolicy
      Environment:
        Variables:
          S3_UPLOAD_BUCKET:
            Ref: UploadsBucket
      Events:
        ApiSignedUrl:
          Type: Api
          Properties:
            Path: /uploads/signed-url
            Method: POST
            RestApiId:
              Ref: Api
      CodeUri: GetSignedUrlFunction
    Metadata:
      SamResourceId: GetSignedUrlFunction
Outputs:
  ApiUrl:
    Description: Base URL for API
    Value:
      Fn::Sub: https://${Api}.execute-api.${AWS::Region}.amazonaws.com/prod
    Export:
      Name:
        Fn::Sub: ${AWS::StackName}-ApiUrl
